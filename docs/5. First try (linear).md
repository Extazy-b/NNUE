# Gradient calculation    
    
## Chain rule for multi-dimensions functions    
```math    
Y = F(z_1, \dots, z_n) \\
z_i = G(x_1, \dots, x_k) \\
\frac{\partial Y}{\partial x_p} \\
dY = \sum_{i=1}^n \frac{\partial Y}{\partial z_i} \, dz_i \\
dz_i = \sum_{j=1}^k \frac{\partial z_i}{\partial x_j} \, dx_j \\
dY = \sum_{j=1}^k \, \left[ \sum_{i=1}^n \frac{\partial Y}{\partial z_i} \cdot \frac{\partial z_i}{\partial x_j} \right] dx_j \\ \\
```    
    
## Constants    
```math    
L - \text{dataset size} \\
N - \text{input layer size} \\
K - \text{inner layer size}
```    
## Accumulator    
### Objects    
```math    
X_1, X_2 \in \mathbb{R}^{N \times L}, \quad X_{1, f, s}, X_{2, f, s} \\
A_1, A_2 \in \mathbb{R}^{K \times N}, \quad A_{1, r, f}, A_{2, r, f} \\
B_1, B_2 \in \mathbb{R}^{K \times 1}, \quad B_{1, r}, B_{2, r}
```    
### Layer definition    
```math    
A_1 \times X_1 \in \mathbb{R}^{K \times L}, \quad A_2 \times X_2 \in \mathbb{R}^{K \times L}
```    
```math    
1_L = (1, ..., 1) \in \R^{1 \times L}     
```    
```math    
Z_1 = A_1 \times X_1 + B_1 \times 1_L \in \R^{K \times L}\\  
```
```math    
Z_2 = A_2 \times X_2 + B_2 \times 1_L \in \R^{K \times L}\\    
```    
```math    
Z_{1, r, s} = \sum_{f=1}^N A_{1, r, f} \cdot X_{1, f, s} + B_{1, r} \quad \in \mathbb{R}^{K \times L}
```    
```math    
Z_{2, r, s} = \sum_{f=1}^N A_{2, r, f} \cdot X_{2, f, s} + B_{2, r} \quad \in \mathbb{R}^{K \times L}
``` 
```math
A = A_1 || A_2 \in \mathbb{R}^{2K \times N} \\
B = B_1 || B_2 \in \mathbb{R}^{2K \times 1} \\
Z = Z_1 || Z_2 \in \mathbb{R}^{2K \times L} : \quad
Z_{u, s} =
\begin{cases}
Z_{1, u, s}, & 1 \le u \le K \\
Z_{2, u-K, s}, & K < u \le 2K
\end{cases}
```    
### First layer derivatives    
```math    
\frac{\partial Z_{u, s}}{\partial A_{r, c}} 
=
\frac{\partial }{\partial A_{r, c}}
\begin{cases}
\sum_{f=1}^N A_{u, f} \cdot X_{1, f, s} + B_{u}, & 1 \le u \le K \\
\sum_{f=1}^N A_{u, f} \cdot X_{2, f, s} + B_{u}, & K < u \le 2K
\end{cases}
= \\ =
\begin{cases}
X_{1, c, s} \cdot \delta_{u, r}, & 1 \le u \le K \\
X_{2, c, s} \cdot \delta_{u, r}, & K < u \le 2K
\end{cases}
```    
---    
```math    
\frac{\partial Z_{u, s}}{\partial B_r} =
\frac{\partial }{\partial B_{r}}
\begin{cases}
\sum_{f=1}^N A_{u, f} \cdot X_{1, f, s} + B_{u}, & 1 \le u \le K \\
\sum_{f=1}^N A_{u, f} \cdot X_{2, f, s} + B_{u}, & K < u \le 2K
\end{cases}
= 
\delta_{u, r}
```    
### Activation    
```math    
H = CReLU(Z, T) \in \mathbb{R}^{2K \times L}, \quad
H_{u, s} =
\begin{cases}
0, & Z_{u, s} < 0 \\
Z_{u, s}, & 0 \le Z_{u, s} \le T \\
T, & Z_{u, s} > T
\end{cases}    
```    
### Activation derivative    
```math    
\frac{\partial H_{u, s}}{\partial Z_{v, t}} =
\begin{cases}
0, & Z_{u, s} < 0 \\
\delta_{u, v} \cdot \delta_{s, t}, & 0 \le Z_{u, s} \le T \\
0, & Z_{u, s} > T
\end{cases} 
```    
### Accumulator derivative    
```math    
\frac{\partial H_{u, s}}{\partial A_{r, c}} 
= \sum_{m=1}^{2K} \sum_{p=1}^L \frac{\partial H_{u, s}}{\partial Z_{m, p}} \cdot \frac{\partial Z_{m, p}}{\partial A_{r, c}} 

\\

= \sum_{m=1}^{2K} \sum_{p=1}^L 
\frac{\partial H_{u, s}}{\partial Z_{m, p}} 
\cdot
\begin{cases}
X_{1, c, p} \cdot \delta_{m, r}, & 1 \le u \le K \\
X_{2, c, p} \cdot \delta_{m, r}, & K < u \le 2K
\end{cases}

\\

= \sum_{m=1}^{2K} \sum_{p=1}^L 
\begin{cases}
0, & Z_{u, s} < 0 \\
X_{1, c, p} \cdot \delta_{m, r} \cdot \delta_{u, m} \cdot \delta_{s, p}, & 0 \le Z_{u, s} \le T, & 1 \le u \le K \\
X_{2, c, p} \cdot \delta_{m, r} \cdot \delta_{u, m} \cdot \delta_{s, p}, & 0 \le Z_{u, s} \le T, & K < u \le 2K \\
0, & Z_{u, s} > T
\end{cases}

= \\ =

\begin{cases}
0, & Z_{u, s} < 0 \\
\sum_{p=1}^L X_{1, c, p} \cdot \delta_{u, r} \cdot \delta_{s, p}, & 0 \le Z_{u, s} \le T, & 1 \le u \le K \\
\sum_{p=1}^L X_{2, c, p} \cdot \delta_{u, r} \cdot \delta_{s, p}, & 0 \le Z_{u, s} \le T, & K < u \le 2K \\
0, & Z_{u, s} > T
\end{cases}

= \\ =

\begin{cases}
0, & Z_{u, s} < 0 \\
X_{1, c, s} \cdot \delta_{u, r}, & 0 \le Z_{u, s} \le T, & 1 \le u \le K \\
X_{2, c, p} \cdot \delta_{u, r}, & 0 \le Z_{u, s} \le T, & K < u \le 2K \\
0, & Z_{u, s} > T
\end{cases}
```    
---  
```math
\frac{\partial H_{u, s}}{\partial B_{r}} 
= 
\begin{cases}
0, & Z_{u, s} < 0 \\
\delta_{u, r}, & 0 \le Z_{u, s} \le T \\
0, & Z_{u, s} > T
\end{cases}
```
## Output layer    
### Layer definition    
```math    
C \in \mathbb{R}^{1 \times 2K}, \quad d \in \mathbb{R} \\
Y_s = \sum_{u=1}^{2K} C_u \cdot H_{u, s} + d    
```    
### Layer derivatives    
```math    
\frac{\partial Y_s}{\partial H_{p, t}} 
= \frac{\partial}{\partial H_{p, t}} \left( \sum_{u=1}^{2K} C_u \cdot H_{u, s} + d \right)
= \sum_{u=1}^{2K} C_u \cdot \delta_{u, p} \cdot \delta_{s, t}
= C_p \cdot \delta_{s, t}
```    
---    

```math    
\frac{\partial Y_s}{\partial C_{p}} 
= \frac{\partial}{\partial C_{p}} \left( \sum_{u=1}^{2K} C_u \cdot H_{u, s} + d \right)
= \sum_{u=1}^{2K} H_{u, s} \cdot \delta_{u, p}
= H_{p, s}
```    
---    
```math    
\frac{\partial Y_s}{\partial d} = 1
```    
    
### Hole network derivatives    
```math    
\frac{\partial Y_s}{\partial A_{r, c}} 
=
\sum_{u=1}^{2K} \sum_{p=1}^L \frac{\partial Y_s}{\partial H_{u, p}} \cdot \frac{\partial H_{u, p}}{\partial A_{r, c}} \\
=
\sum_{u=1}^{2K} \sum_{p=1}^L C_u \cdot \delta_{s, p}
\cdot
\begin{cases}
0, & Z_{u, p} < 0 \\
X_{1, c, p} \cdot \delta_{u, r}, & 0 \le Z_{u, p} \le T, & 1 \le u \le K \\
X_{2, c, p} \cdot \delta_{u, r}, & 0 \le Z_{u, p} \le T, & K < u \le 2K \\
0, & Z_{u, p} > T
\end{cases}\\
=
\begin{cases}
0, & Z_{u, p} < 0 \\
\sum_{u=1}^{2K} \sum_{p=1}^L  X_{1, c, p} \cdot \delta_{u, r} \cdot C_u \cdot \delta_{s, p}, & 0 \le Z_{u, p} \le T, & 1 \le u \le K \\
\sum_{u=1}^{2K} \sum_{p=1}^L X_{2, c, p} \cdot \delta_{u, r} \cdot C_u \cdot \delta_{s, p}, & 0 \le Z_{u, p} \le T, & K < u \le 2K \\
0, & Z_{u, p} > T
\end{cases}\\
=
\begin{cases}
0, & Z_{r, s} < 0 \\
 X_{1, c, s} \cdot  C_r, & 0 \le Z_{r, s} \le T, & 1 \le r \le K \\
X_{2, c, s}   \cdot C_r, & 0 \le Z_{r, s} \le T, & K < r \le 2K \\
0, & Z_{r, s} > T
\end{cases}
```
---
```math    
\frac{\partial Y_s}{\partial B_r} 
=
\sum_{u=1}^{2K} \sum_{p=1}^L \frac{\partial Y_s}{\partial H_{u, p}} \cdot \frac{\partial H_{u, p}}{\partial B_r} \\
=
\sum_{u=1}^{2K} \sum_{p=1}^L C_u \cdot \delta_{s, p}
\cdot
\begin{cases}
0, & Z_{u, p} < 0 \\
\delta_{u, r}, & 0 \le Z_{u, p} \le T \\
0, & Z_{u, p} > T
\end{cases}\\
=
\begin{cases}
0, & Z_{u, p} < 0 \\
\sum_{u=1}^{2K} \sum_{p=1}^L  \delta_{u, r} \cdot C_u \cdot \delta_{s, p}, & 0 \le Z_{u, p} \le T\\
0, & Z_{u, p} > T
\end{cases}\\
=
\begin{cases}
0, & Z_{r, s} < 0 \\
C_r, & 0 \le Z_{r, s} \le T\\
0, & Z_{u, s} > T
\end{cases}
```

## Loss
### Loss definition
```math
Y_{exp} \in \mathbb{R}^{1 \times L} \\
Loss = \frac{1}{L} \sum_{s=1}^L (Y_{exp, s} - Y_s)^2
```
### Loss deriviate
```math
\frac{\partial Loss}{\partial Y_s} =
\frac{2}{L} (Y_s - Y_{exp, s})
```

## Pre-final derivatives
```math
\frac{\partial Loss}{\partial Y^i} = \frac{2}{L} \left( Y^i - Y_{exp}^i \right)
```
---
```math
\frac{\partial Y_s}{\partial A_{r, c}} = 
\begin{cases}
0, & Z_{r, s} < 0 \\
 X_{1, c, s} \cdot  C_r, & 0 \le Z_{r, s} \le T, & 1 \le r \le K \\
X_{2, c, s}   \cdot C_r, & 0 \le Z_{r, s} \le T, & K < r \le 2K \\
0, & Z_{u, s} > T
\end{cases}
```
---
```math
\frac{\partial Y_s}{\partial B_{r}} = 
\begin{cases}
0, & Z_{r, s} < 0 \\
C_r, & 0 \le Z_{r, s} \le T\\
0, & Z_{u, s} > T
\end{cases}
```
---
```math    
\frac{\partial Y_s}{\partial C_{p}} = H_{p, s}
```    
---    
```math    
\frac{\partial Y_s}{\partial d} = 1
```    

## Final derivatives
```math
\frac{\partial Loss}{\partial A_{r, c}} 

= \sum_{s=1}^L \frac{\partial Loss}{\partial Y_s} \cdot \frac{\partial Y_s}{\partial A_{r, c}} \\

= \frac{2}{L} \sum_{s=1}^L (Y_s - Y_{exp, s}) 
\cdot
\begin{cases}
0, & Z_{r, s} < 0 \\
 X_{1, c, s} \cdot  C_r, & 0 \le Z_{r, s} \le T, & 1 \le r \le K \\
X_{2, c, s}   \cdot C_r, & 0 \le Z_{r, s} \le T, & K < r \le 2K \\
0, & Z_{u, s} > T
\end{cases} \\
= \frac{2C_r}{L} 
\cdot
\begin{cases}
0, & Z_{r, s} < 0 \\
\sum_{s=1}^L X_{1, c, s} \cdot (Y - Y_{exp})_s , & 0 \le Z_{r, s} \le T, & 1 \le r \le K \\
\sum_{s=1}^L X_{2, c, s} \cdot (Y - Y_{exp})_s, & 0 \le Z_{r, s} \le T, & K < r \le 2K \\
0, & Z_{r, s} > T
\end{cases}
```
---
```math
\frac{\partial Loss}{\partial B_r} 

= \sum_{s=1}^L \frac{\partial Loss}{\partial Y_s} \cdot \frac{\partial Y_s}{\partial B_r} \\

= \frac{2}{L} \sum_{s=1}^L (Y_s - Y_{exp, s}) 
\cdot
\begin{cases}
0, & Z_{r, s} < 0 \\
C_r, & 0 \le Z_{r, s} \le T \\
0, & Z_{r, s} > T
\end{cases} \\
= \frac{2C_r}{L} 
\cdot
\begin{cases}
0, & Z_{r, s} < 0 \\
\sum_{s=1}^L (Y - Y_{exp})_s , & 0 \le Z_{r, s} \le T,\\
0, & Z_{r, s} > T
\end{cases} \\
```
---
```math
\frac{\partial Loss}{\partial C_p} 

= \sum_{s=1}^L \frac{\partial Loss}{\partial Y_s} \cdot \frac{\partial Y_s}{\partial C_p} =  \frac{2}{L} \sum_{s=1}^L (Y_s - Y_{exp, s}) \cdot H_{p, s} = \\
= \frac{2}{L} \left[ H \cdot (Y - Y_{exp})^T \right]_p
```
---
```math
\frac{\partial Loss}{\partial C_p} 

= \sum_{s=1}^L \frac{\partial Loss}{\partial Y_s} \cdot \frac{\partial Y_s}{\partial d} =  \frac{2}{L} \sum_{s=1}^L (Y_s - Y_{exp, s})
```